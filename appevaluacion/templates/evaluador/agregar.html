{% extends "plantilla.html" %}
{% block title %} POSGRADO | Agregar Evaluadores  {% endblock title %}

{% load crispy_forms_tags %}

{% block content %}
<style>
    .card-header{
        background-color: #2f5793;
        color: white;
    }

    input[name="codigo_evaluador"],[name="apellidos"], [name="nombres"],[name="email"],[name="dni"],[name="cargo"], [name="unidad"], [name="user"]
    {
        height: 30px;
        font-size: 11px;
    }
</style>
<div class="p-1">
    <div class="card mx-5 my-4 ">
        <div class="card-header  d-flex justify-content-between  ">
            <h4 class="card-title pt-2 pl-5" >NUEVO EVALUADOR</h4>    
            <div class="ml-auto"><a href="{% url 'listar_evaluadores' %}" class='btn btn-sm' style="background-color:#e7edf7 ;"><< Atrás</a>
        </div>     
        </div>       
        <div class="card-body">                   
            <div class="row">
                <div class="row">
                     <!-- Unidades -->                              
                    <div class="col-lg-6 col-md-8 col-sm-6 d-flex align-items-center">
                        <label for="selectUnidad" class="mt-1 mr-2">Unidades: </label>                                                             
                        <select class="form-control form-control-sm" id="selectUnidad" name="unidad">
                            <option value="Todos" {% if unidad_actual == 'Todos' %}selected{% endif %}>Todos</option>
                            {% for unidad in unidades %}
                                <option value="{{ unidad.idUnidad }}" {% if unidad.des_unidad == unidad_actual %}selected{% endif %}>{{ unidad.des_unidad }}</option>
                            {% endfor %}
                        </select>
                    </div> 
                    <!-- Añadir Terna de Evaluadores -->
                    <div class="col-lg-3">
                        <button id="crearTernaBtn" class="btn" style="width: 100%; color: rgb(47, 87, 147); border-color: rgb(47, 87, 147); font-size: 11px;"><i class='fas fa-plus'></i> Crear Terna</button>
                    </div>                      
                    <!-- Añadir un Evaluador -->
                    <div class="col-lg-3">
                        <button type="" class="btn" style="width: 100%; color: rgb(47, 87, 147); border-color: rgb(47, 87, 147); font-size: 11px;"><i class='fas fa-plus'></i> Crear Evaluador</button>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-body">
                                <form method="post" class="" id="formEvaluador">
                                    {% csrf_token %}
                                    <div class="row">
                                        <div class="col-lg-4">{{ form.codigo_evaluador | as_crispy_field }}</div>  
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-6">{{ form.apellidos | as_crispy_field }}</div>
                                        <div class="col-lg-6">{{ form.nombres | as_crispy_field }}</div> 
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-3">{{ form.dni | as_crispy_field }}</div>   
                                        <div class="col-lg-9">{{ form.email | as_crispy_field }}</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-4">{{ form.cargo | as_crispy_field }}</div>   
                                        <div class="col-lg-8">{{ form.unidad | as_crispy_field }}</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-4"><label for="">User*</label></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-3" style="margin-right: -30px; ">{{ form.user | as_crispy_field }}</div>                                           
                                        <div class="col-lg-1 mx-0" style="margin-top: -5px;" >
                                            <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#crearUsuarioModal" id="crearUsuarioModalButton">
                                                <i class="fa-solid fa-user-plus fa-lg"></i>
                                            </button>
                                        </div>         
                                        <div class="col-lg-1" style="margin-top: -5px;">
                                            <button type="button" id="refreshButton" class="btn" style="margin: 0;"><i class="fa-solid fa-rotate-left fa-lg" style="color: #a6b2c4;"></i></button>
                                        </div> 
                                        <div class="col-lg-2" > </div>
                                        <div class="col-lg-4" >{{ form.activo | as_crispy_field }}</div>                                                                
                                    </div>  
                                    <div class="row">
                                        <div class="col-lg-12" >
                                            <button type="" class="btn" style="width: 100%; color: #fff;background-color: #2f5793; font-size: 11px;"> Añadir</button>
                                        </div>  
                                    </div>                                
                                </form>                                                    
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div id="ternaContainer" class="mt-3"></div>
                    </div>
                </div>
                

                   

                      
                   
                    
            </div>     
                      
        </div>
    </div>
</div>

<!-- Modal para crear un nuevo usuario -->
<div class="modal fade" id="crearUsuarioModal" tabindex="-1" aria-labelledby="crearUsuarioModalLabel" aria-hidden="true">
    <div class="modal-dialog d-flex align-items-center justify-content-center"">
        <div class="modal-content" style="width: 60%;">
            <div class="modal-header" style="background-color: #2f5793; color: #fff; ">
                <h5 class="modal-title" id="crearUsuarioModalLabel" style="font-size: 16px;">NUEVO USUARIO</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body mx-3 my-1">
            <!-- Formulario para crear un nuevo usuario -->
                <form id="crearUsuarioForm">
                    {% csrf_token %}
                    <div class="mb-3">
                    <label for="username" class="form-label">Nombre de Usuario</label>
                    <input type="text" class="form-control form-control-sm" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="" class="form-control form-control-sm" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirmar Contraseña</label>
                    <input type="" class="form-control form-control-sm" id="confirmPassword" name="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="crearUsuarioForm" class="btn" style="width: 100%; background-color: #28487c; font-size: 11px; color: white;">Crear Usuario</button> 
                <button type="button" class="btn" data-bs-dismiss="modal" style="width: 100%; background-color: rgb(231, 237, 247); font-size: 11px; color: black;">Cancelar</button>
            </div>
        </div>
    </div>
</div>
  

{% endblock content %}

{% block js %}
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {% if messages %}
        {% for m in messages %}
            <script>
                Swal.fire({
                "title": "Warning",
                "text":"{{m}}",
                "icon":"info"
                })
            </script>
        {% endfor %}
    {% endif %}

    <!-- Crear Terna de Evaluadores -->
    <script>
       $(document).ready(function() {
    var ternaCounter = 0; // Contador para el número de terna
    var rowsFilled = 0; // Contador para el número de filas llenadas en la terna actual

    // Al hacer clic en el botón de crear Terna
    $('#crearTernaBtn').click(function() {
        if (rowsFilled === 3 || ternaCounter === 0) { // Permitir la creación de la primera terna o si las tres filas están llenas
            if (ternaCounter < 5) { // Verifica si el contador es menor que 5
                ternaCounter++; // Incrementa el contador de terna
                createNewTerna(ternaCounter); // Crea una nueva terna
            } else {
                alert("Solo se pueden crear hasta 5 ternas.");
            }
        } else {
            alert("Por favor, complete las tres filas antes de crear la siguiente terna.");
        }
    });

    // Función para crear una nueva terna
    function createNewTerna(ternaNumber) {
        var ternaTitle = "Terna " + ternaNumber; // Título de la terna
        var ternaTable = '<table class="table table-striped table-sm" id="tablaEvaluadores">' +
                            '<thead>' +
                                '<tr>' +
                                    '<th scope="col">Codigo</th>' +
                                    '<th scope="col">Nombres y apellidos</th>' +
                                    '<th scope="col">Dni</th>' +
                                    '<th scope="col">Cargo</th>' +
                                '</tr>' +
                            '</thead>' +
                            '<tbody>' +                                               
                            '</tbody>' +
                        '</table>';

        var ternaHtml = '<div class="terna">' +
                            '<h3>' + ternaTitle + '</h3>' +
                            ternaTable +
                        '</div>';

        $('#ternaContainer').append(ternaHtml); // Agrega la terna al contenedor
        rowsFilled = 0; // Reinicia el contador de filas llenadas
    }

    // Función para contar las filas llenadas en la terna actual
    $('#ternaContainer').on('click', '.table tr', function() {
        rowsFilled++;
    });

    // Contar las filas llenadas al insertar nuevas filas
    $(document).on('DOMNodeInserted', function(e) {
        if ($(e.target).is('.table tr')) {
            rowsFilled++;
        }
    });
});

    </script>
    
    
    

    <!-- Llena la Terna -->
    <script>
        document.getElementById('formEvaluador').addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);
        
            fetch("/evaluador/create/", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.errors) {
                    alert("Errores al crear evaluador");
                } else {
                    var tbody = document.getElementById('tablaEvaluadores').getElementsByTagName('tbody')[0];
                    var newRow = tbody.insertRow();
                    var cell1 = newRow.insertCell(0);
                    cell1.textContent = data.data.codigo_evaluador;
                    var cell2 = newRow.insertCell(1);
                    cell2.textContent = data.data.nombres + data.data.apellidos;               
                    var cell3 = newRow.insertCell(2);
                    cell3.textContent = data.data.dni;                                   
                    var cell4 = newRow.insertCell(3);
                    cell4.textContent = data.data.cargo;
                    this.reset();
                }
            })
            .catch(error => console.error('Error:', error));
        });
    </script>

    
        <script>
            $(document).ready(function() {
    $('#crearUsuarioForm').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            url: '/create-user/',  // Reemplaza '/ruta/para/crear/usuario/' con la URL correcta de tu vista en Django
            type: 'POST',
            data: $(this).serialize(),
            success: function(data) {
                alert('Usuario creado con éxito');
                $('#crearUsuarioModal').modal('hide');  // Cierra el modal después de crear el usuario
                // Aquí puedes agregar código para actualizar la interfaz de usuario si es necesario
            },
            error: function(xhr) {
                alert('Error al crear usuario: ' + xhr.responseText);
            }
        });
    });
});
        </script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const usuarioModalButton = document.getElementById('crearUsuarioModalButton');
        usuarioModalButton.addEventListener('click', function() {
            const nombres = document.querySelector('#id_nombres').value;
            const apellidos = document.querySelector('#id_apellidos').value;
            const usernameField = document.querySelector('#username');
            const passwordField = document.querySelector('#password');
            const confirmPasswordField = document.querySelector('#confirmPassword');
    
            // Generar el nombre de usuario
            let nombreDividido = nombres.split(' ');
            let apellidoPrimero = apellidos.split(' ')[0].substring(0, 2);
            usernameField.value = nombreDividido[0].toLowerCase() + apellidoPrimero.toLowerCase();
    
            // Generar contraseña segura
            let password = generarPassword();
            passwordField.value = password;
            confirmPasswordField.value = password; // Asegura que la contraseña y su confirmación sean iguales
    
            // Función para generar contraseña
            function generarPassword() {
                const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
                let contraseña = '';
                for (let i = 0; i < 8; i++) {
                    contraseña += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
                }
                return contraseña;
            }
        });
    });
    </script>

    <script>
        $(document).ready(function() {
            $('#refreshButton').click(function() {
                $.ajax({
                    url: '/update-user/',  // Asegúrate de que esta URL es correcta
                    type: 'GET',
                    success: function(data) {
                        var select = $('#id_user');  // Cambia esto por el ID real del select generado por Django
                        select.empty(); // Vaciar las opciones actuales
                        data.forEach(function(user) {
                            select.append($('<option></option>').val(user.id).html(user.username)); // Usa `username` para mostrar
                        });
                    },
                    error: function() {
                        alert('Error al cargar los usuarios');
                    }
                });
            });
        });
        </script>
        
    

{% endblock %} 